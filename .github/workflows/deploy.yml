name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

# Prevent concurrent production deployments
concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  # ============================================================================
  # WAIT FOR CI TO PASS
  # ============================================================================

  wait-for-ci:
    name: Wait for CI Pipeline
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Wait for CI workflow
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.ref }}
          check-name: 'CI Pipeline Success'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          allowed-conclusions: success

  # ============================================================================
  # DEPLOY TO VERCEL
  # ============================================================================

  deploy:
    name: Deploy to Vercel Production
    runs-on: ubuntu-latest
    needs: wait-for-ci
    timeout-minutes: 20
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel environment information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build project artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy prebuilt artifacts to Vercel
        id: deploy
        run: |
          url=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "### Deployment Successful! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Production URL:** $url" >> $GITHUB_STEP_SUMMARY
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Wait for deployment to be ready
        run: |
          echo "Waiting 30 seconds for deployment to stabilize..."
          sleep 30

  # ============================================================================
  # POST-DEPLOYMENT VERIFICATION
  # ============================================================================

  verify:
    name: Post-Deployment Verification
    runs-on: ubuntu-latest
    needs: deploy
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Health check
        run: |
          url="${{ needs.deploy.outputs.url }}"
          max_attempts=10
          attempt=1

          echo "Running health checks on: $url"

          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt/$max_attempts..."

            # Try health endpoint first
            if curl -f -s -L "${url}/api/health" > /dev/null 2>&1; then
              echo "✅ Health check passed!"
              exit 0
            fi

            # Fallback to homepage
            if curl -f -s -L "${url}/" > /dev/null 2>&1; then
              echo "✅ Homepage check passed!"
              exit 0
            fi

            echo "Health check failed, retrying in 10 seconds..."
            sleep 10
            attempt=$((attempt + 1))
          done

          echo "❌ Health check failed after $max_attempts attempts"
          exit 1

      - name: Performance check
        run: |
          url="${{ needs.deploy.outputs.url }}"

          # Measure response time
          response_time=$(curl -w "%{time_total}\n" -o /dev/null -s -L "${url}/" 2>/dev/null || echo "0")

          echo "### Performance Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Homepage response time:** ${response_time}s" >> $GITHUB_STEP_SUMMARY

          # Check if response time is acceptable (< 3 seconds)
          if (( $(echo "$response_time > 0 && $response_time < 3.0" | bc -l 2>/dev/null || echo 0) )); then
            echo "✅ Response time acceptable" >> $GITHUB_STEP_SUMMARY
          elif (( $(echo "$response_time >= 3.0" | bc -l 2>/dev/null || echo 0) )); then
            echo "⚠️ Response time slower than expected (>3s)" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Could not measure response time" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Deployment summary
        run: |
          echo "### Deployment Complete! :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ needs.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ROLLBACK ON FAILURE
  # ============================================================================

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy, verify]
    if: failure()

    steps:
      - name: Alert about deployment failure
        run: |
          echo "### Deployment Failed :x:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action Required:** Manual review and potential rollback needed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs above and consider rolling back to the previous version if needed." >> $GITHUB_STEP_SUMMARY
          exit 1
