name: Security Headers Verification

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]
  workflow_dispatch:
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'

env:
  NODE_VERSION: '20'

concurrency:
  group: security-headers-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # SECURITY HEADERS VERIFICATION
  # ============================================================================

  verify-headers:
    name: Verify Security Headers
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        env:
          CI: true

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1

      - name: Start Next.js server
        run: |
          npm run start &
          echo "Waiting for server to start..."
          npx wait-on http://localhost:3000 --timeout 60000
        env:
          PORT: 3000

      - name: Check security headers
        run: |
          echo "### Security Headers Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Function to check header
          check_header() {
            local url=$1
            local header=$2
            local value=$(curl -s -I "$url" | grep -i "^$header:" || echo "NOT FOUND")
            echo "| $header | $value |" >> $GITHUB_STEP_SUMMARY
          }

          echo "#### HTTP Security Headers" >> $GITHUB_STEP_SUMMARY
          echo "| Header | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY

          # Check critical security headers
          check_header "http://localhost:3000" "X-Frame-Options"
          check_header "http://localhost:3000" "X-Content-Type-Options"
          check_header "http://localhost:3000" "X-XSS-Protection"
          check_header "http://localhost:3000" "Strict-Transport-Security"
          check_header "http://localhost:3000" "Content-Security-Policy"
          check_header "http://localhost:3000" "Referrer-Policy"
          check_header "http://localhost:3000" "Permissions-Policy"

      - name: Validate required headers
        run: |
          FAILED=0

          # Required security headers
          REQUIRED_HEADERS=(
            "X-Frame-Options"
            "X-Content-Type-Options"
            "Referrer-Policy"
          )

          for header in "${REQUIRED_HEADERS[@]}"; do
            if ! curl -s -I http://localhost:3000 | grep -qi "^$header:"; then
              echo "::error::Missing required security header: $header"
              FAILED=1
            else
              echo "âœ“ $header present"
            fi
          done

          if [ $FAILED -eq 1 ]; then
            echo "::warning::Some required security headers are missing"
            # Don't fail the build, just warn
          else
            echo "All required security headers present"
          fi

      - name: Check HTTPS enforcement
        run: |
          # Verify HSTS header for HTTPS enforcement
          hsts=$(curl -s -I http://localhost:3000 | grep -i "Strict-Transport-Security" || echo "")

          if [ -z "$hsts" ]; then
            echo "::warning::HSTS header not found - HTTPS enforcement may not be active"
          else
            echo "HSTS header present: $hsts"
          fi

      - name: Test CORS configuration
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### CORS Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Test CORS headers
          cors_origin=$(curl -s -I -H "Origin: https://example.com" http://localhost:3000 | grep -i "Access-Control-Allow-Origin" || echo "NOT CONFIGURED")
          echo "**CORS Origin:** $cors_origin" >> $GITHUB_STEP_SUMMARY

      - name: Security headers report
        if: always()
        run: |
          cat > security-headers-report.json << 'EOF'
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "headers_checked": [
              "X-Frame-Options",
              "X-Content-Type-Options",
              "X-XSS-Protection",
              "Strict-Transport-Security",
              "Content-Security-Policy",
              "Referrer-Policy",
              "Permissions-Policy"
            ]
          }
          EOF

      - name: Upload security report
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: security-headers-report
          path: security-headers-report.json
          retention-days: 30

  # ============================================================================
  # OWASP SECURITY CHECKS
  # ============================================================================

  owasp-checks:
    name: OWASP Security Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        env:
          CI: true

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Start Next.js server
        run: |
          npm run start &
          echo "Waiting for server to start..."
          npx wait-on http://localhost:3000 --timeout 60000
        env:
          PORT: 3000

      - name: Install OWASP ZAP
        run: |
          docker pull zaproxy/zap-stable || echo "ZAP install skipped"

      - name: Run OWASP ZAP baseline scan
        continue-on-error: true
        run: |
          # Run ZAP baseline scan
          docker run -v $(pwd):/zap/wrk/:rw \
            zaproxy/zap-stable \
            zap-baseline.py \
            -t http://host.docker.internal:3000 \
            -r zap-report.html \
            -J zap-report.json || echo "ZAP scan completed with findings"

      - name: Upload ZAP results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: owasp-zap-results
          path: |
            zap-report.html
            zap-report.json
          retention-days: 30

      - name: Check for critical vulnerabilities
        if: always()
        run: |
          if [ -f "zap-report.json" ]; then
            echo "ZAP scan completed. Review results in artifacts."
          fi

  # ============================================================================
  # SSL/TLS CONFIGURATION CHECK
  # ============================================================================

  ssl-tls-check:
    name: SSL/TLS Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Check production SSL/TLS
        run: |
          echo "### SSL/TLS Configuration Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # This would check the production deployment
          # For now, we'll document the requirements
          echo "#### Requirements:" >> $GITHUB_STEP_SUMMARY
          echo "- TLS 1.2 or higher" >> $GITHUB_STEP_SUMMARY
          echo "- Strong cipher suites" >> $GITHUB_STEP_SUMMARY
          echo "- Valid SSL certificate" >> $GITHUB_STEP_SUMMARY
          echo "- HSTS enabled" >> $GITHUB_STEP_SUMMARY

      - name: Verify certificate chain
        run: |
          # This would verify the production certificate
          echo "Certificate verification would happen for production deployment"

  # ============================================================================
  # SECURITY SUMMARY
  # ============================================================================

  security-summary:
    name: Security Verification Summary
    runs-on: ubuntu-latest
    needs: [verify-headers, owasp-checks, ssl-tls-check]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "### ðŸ”’ Security Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Security Headers | ${{ needs.verify-headers.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OWASP Checks | ${{ needs.owasp-checks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SSL/TLS Config | ${{ needs.ssl-tls-check.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Final status
        run: |
          if [ "${{ needs.verify-headers.result }}" != "success" ]; then
            echo "::warning::Security headers verification needs attention"
          fi

          echo "Security verification completed"
